---
title: "Homework 6"
author: "Emma Sexton"
date: "Due 3 Dec 2022"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(viridis)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
	fig.width = 8, 
  fig.height = 6,
  out.width = "90%"
)

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

theme_set(theme_minimal() + theme(legend.position = "bottom"))
```

```{r load_libraries}
library(tidyverse)
library(modelr)
```

## Problem 1

To obtain a distribution for $\hat{r}^2$, we'll follow basically the same procedure we used for regression coefficients: draw bootstrap samples; the a model to each; extract the value I'm concerned with; and summarize. Here, we'll use `modelr::bootstrap` to draw the samples and `broom::glance` to produce `r.squared` values. 

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("USW00094728"),
    var = c("PRCP", "TMIN", "TMAX"), 
    date_min = "2017-01-01",
    date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  select(name, id, everything())
```


## Problem 2

```{r}
homicide_df <- 
  read_csv(
    'data/homicide-data.csv') %>%  
  janitor::clean_names()
```

```{r}
homicide_summary <- 
  homicide_df %>% 
  mutate(
    city_state = str_c(city, sep = ", ", state),
    victim_age = as.numeric(victim_age),
    hom_solved = ifelse(disposition == "Closed by arrest", 1, 0)
  ) %>%
  filter(!(city_state %in% c("Tulsa, AL", "Dallas, TX", "Phoenix, AZ", "Kansas City, MO")),
         victim_race %in% c("White", "Black"))
```

### Run logistic regression for Baltimore, MD

```{r}
baltimore_glm_df <- homicide_summary %>% 
  filter(city_state == "Baltimore, MD")

baltimore_glm_results <- 
  baltimore_glm_df %>% 
  glm(hom_solved ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

baltimore_glm_results %>% 
  broom::tidy() %>% 
  mutate(odds_ratio = exp(estimate),
         lower_ci = exp(estimate - 1.96*std.error),
         upper_ci = exp(estimate + 1.96*std.error)
         ) %>% 
  select(term, odds_ratio, lower_ci, upper_ci) %>% 
  filter(term == "victim_sexMale") %>% 
  knitr::kable(col.names = c("Term", "Odds Ratio", "Lower 95% CI", "Upper 95% CI"), digits = 3)
```

### Run logistic regression for all City, States

We need to create a function to iterate across each `city_state` group. 

```{r}
glm_homicide <- function(homicide_summary) {
  
  glm(hom_solved ~ victim_age + victim_sex + victim_race, data = homicide_summary, family = binomial()) %>% 
    broom::tidy() %>% 
    mutate(
      odds_ratio = exp(estimate),
      lower_ci =   exp(estimate - 1.96*std.error),
      upper_ci =   exp(estimate + 1.96*std.error)
    ) %>% 
    select(term, odds_ratio, lower_ci, upper_ci) %>% 
    filter(term == "victim_sexMale")
  
}
```

Now we need to apply that function to nested lists for each `city_state`.

```{r}
homicide_data_analysis <- 
  homicide_summary %>% 
  select(city_state, everything()) %>% 
  nest(data = uid:hom_solved) %>% 
  mutate(glm_homicide_output = purrr::map(.x = data, ~ glm_homicide(.x))) %>% 
  unnest(cols = glm_homicide_output)
```


### Plot OR's and CI's for each City, State

```{r}
homicide_data_analysis %>%
  ggplot(aes(x = reorder(city_state, odds_ratio), y = odds_ratio)) +
  geom_point() +
  geom_errorbar(aes(ymin = lower_ci, ymax = upper_ci)) +
  labs(
    title = , 
    x = "City, State",
    y = "Odds Ratio Estimates"
  ) +
  theme(
    axis.text.x = element_text(angle = 60, hjust = 1),
    legend.position = "none"
  )
```


## Problem 3

### Load and clean data for regression analysis

```{r}
birthweight_df <- 
  read_csv(
    'data/birthweight.csv') %>%  
  janitor::clean_names() %>%
  mutate(
    babysex = factor(babysex, labels = c("male", "female")),
    frace = factor(frace, labels = c("white", "black", "asian", "puerto rican", "other")),
    malform = factor(malform, labels = c("absent", "present")),
    mrace = factor(mrace, labels = c("white", "black", "asian", "puerto rican"))
  )

skimr::skim(birthweight_df)
```

Four variables (`babysex`, `frace`, `malform`, `mrace`) were converted to factors since they are categorical. `frace` had no "unknown" responses and `mrace` had no "other" responses, therefore, neither of those responses were included in the factor recode. There is no other missing data for any other variables. 

### Regression Model Proposal

We hypothesize that birth weight is associated with the baby's length at birth (cm). 

```{r}
birthweight_df %>% 
  ggplot(aes(x = blength, y = bwt)) +
  geom_point(alpha = 0.5)

```

To test this hypothesis, we will use a regression model using birth weight and the baby's length at birth. Below, predictions (x) and residuals (y)  

```{r}
bw_blength_fit <- lm(bwt ~ blength, data = birthweight_df)

bw_blength_fit %>% 
  broom::tidy() %>% 
  knitr::kable(col.names = c("Term", "Estimate", "Standard Error", "Statistic", "P-Value"), digits = 3)

birthweight_df %>% 
  mutate(
    modelr::add_residuals(birthweight_df, bw_blength_fit),
    modelr::add_predictions(birthweight_df, bw_blength_fit)
  ) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point()
```


### Fitting Comparison Models

```{r}

```



